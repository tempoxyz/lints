id: unsafe-needs-safety-comment
message: "Unsafe block requires a SAFETY comment explaining why this is safe."
severity: warning
language: rust
note: |
  All unsafe code should have a `// SAFETY:` comment explaining why
  the unsafe operation is sound.
  
  Good:
  ```rust
  // SAFETY: We have verified the pointer is valid and aligned
  unsafe { *ptr }
  
  // SAFETY: caller guarantees ptr is valid
  let x = unsafe { *ptr };
  ```
  
  The SAFETY comment must immediately precede the unsafe block or its
  enclosing statement (no intervening statements).
  
  To disable this rule:
  - Line: add `// ast-grep-ignore: unsafe-needs-safety-comment` on the line before
rule:
  kind: unsafe_block
  not:
    any:
      # SAFETY comment immediately before the unsafe block itself
      - follows:
          stopBy: neighbor
          kind: line_comment
          regex: 'SAFETY:'
      - follows:
          stopBy: neighbor
          kind: block_comment
          regex: 'SAFETY:'
      # SAFETY comment before enclosing let_declaration
      - inside:
          kind: let_declaration
          follows:
            stopBy: neighbor
            kind: line_comment
            regex: 'SAFETY:'
      - inside:
          kind: let_declaration
          follows:
            stopBy: neighbor
            kind: block_comment
            regex: 'SAFETY:'
      # SAFETY comment before enclosing expression_statement
      - inside:
          kind: expression_statement
          follows:
            stopBy: neighbor
            kind: line_comment
            regex: 'SAFETY:'
      - inside:
          kind: expression_statement
          follows:
            stopBy: neighbor
            kind: block_comment
            regex: 'SAFETY:'
